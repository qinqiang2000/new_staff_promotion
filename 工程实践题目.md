## 概述
1. 模拟商户系统、支付系统和对账系统
2. 商户系统往支付系统发起支付和退款请求，后者按规定处理请求
3. 商户系统和支付系统通过对账系统进行对账和稽核，以确认数据一致

## 业务场景

1. 商户系统向支付系统发起支付请求，支付系统记录支付订单，并将收款账号和金额放到缓存中
2. 支付系统定时将2种缓存的数据取出，批量计算后为收款账号增加相应金额
3. 商户系统向支付系统发起提款请求，将某个用户账号上的金额提取出来，金额减少
4. 商户系统和支付系统上的支付订单进行比对
5. 对账系统向商户系统和支付系统发起对账请求，进行账户金额稽核，商户系统支付与提款金额之和与支付系统金额比较

## 流程概要

1. 多线程发起支付请求。
  swagger触发商户系统请求，商户系统构造支付请求报文（json格式），入库，向支付系统发起支付请求，支付系统做校验，入库，并将金额加入到缓存中，向商户系统返回结果，商户系统更新订单状态。

2. 定时获取缓存数据并记录入账户。
  支付系统定时获取缓存中的数据，汇总以后更新账户总金额。

3. 多线程发起提款请求。
  swagger触发商户系统请求，商户系统构造提款请求报文（json格式），向支付系统发起提款请求，支付系统根据提款金额从账户上扣取相应的金额，扣款成功返回，失败返回失败信息。

4. 第2步完成的数据，对账。

   将商户系统、支付系统**成功的**、**成功的**、**成功的**支付订单、提款订单分别导出成csv文件，将两个文件汇总到支付系统的目录上，根据订单号将两端的数据进行比对。对平记录记为为F000，支付系统比商户系统多的记录记为F113，商户系统比支付系统多的记录记为F114，支付系统和商户系统都有但金额不相同的记录记为F115。详见对账示例。

5. 账号金额稽核。

   对账系统将商户系统导出的支付订单、提款订单csv文件按账号进行处理，汇总（求和）金额值（支付订单金额为正值，提款订单金额为负值），与支付系统对应账号金额值进行比对，输出结果。详见稽核示例。
   
## 请求示例图
![请求示例图](https://github.com/wenxiao156/IOCDemo/blob/master/%E8%AF%B7%E6%B1%82%E7%A4%BA%E4%BE%8B.png)

## 支付请求报文示例

请求报文：
```json
{"request_time": "2019-08-29 17:15:20", "request_id": "20190829171520123456", "saler_id": "saler2", "total_fee": "100"}
```
返回报文：

```json
{"response_time": "2019-08-29 17:15:25", "request_id": "20190829171520123456", "response_id": "20190829171525654321", "saler_id": "saler2", "total_fee": "100", "reponse_code": "SUCCESS", "response_msg": "OK"}
```



**字段说明**

|     属性      |          取值要求           |                             备注                             |
| :-----------: | :-------------------------: | :----------------------------------------------------------: |
| request_time  |          timestamp          |                     yyyy-MM-dd hh:mm:ss                      |
|  request_id   | 20位，前14位要求为timestamp |              前14位格式yyyyMMddhhmmss，保证唯一              |
|   saler_id    |         用户ID唯一          |                          收款用户ID                          |
|   total_fee   |            整数             |                       付款金额，单位分                       |
| response_time |       同request_time        |                                                              |
|  response_id  |        同request_id         |                                                              |
| response_code  |            枚举             |  返回代码，通过返回代码判断交易是否成功，取值：SUCCESS/FAIL  |
|  response_msg  |           字符串            | 当response_code=FAIL时返回具体失败原因，当response_code=SUCCESS时可返回空字符串。 |



## 提款请求报文示例
请求报文：
```json
{"request_time": "2019-08-29 17:16:21", "request_id": "20190829171621334455", "withdraw_money": "100", "saler_id": "saler1"}
```
返回报文：

```json
{"response_time": "2019-08-29 17:16:30", "request_time": "2019-08-29 17:16:21", "request_id": "20190829171621334455", "withdraw_money": "100", "saler_id": "saler1", "response_id": "20190829171630554433", "reponse_code": "FAIL", "response_msg": "账户余额不足，提款失败"}
```

**字段说明**

|      属性      | 取值要求 |       备注       |
| :------------: | :------: | :--------------: |
| withdraw_money |   整数   | 提款金额，单位分 |
|    其余同上    |          |                  |



## 对账示例

> 文件构造字段未按上文描述的规范填写

商户系统支付文件：

|      request_id      | response_id |       total_fee       |    其余字段……   | 其余字段…… |
| :------------: | :------: | :--------------: | :------: | -------------- |
| request_id_1 | response_id_1 | 10 | |  |
| request_id_2 | response_id_2 | 20 | |  |
| request_id_3 | response_id_3 | 3 | |  |

支付系统支付文件：

|      request_id      | response_id |       total_fee       |    其余字段……   | 其余字段…… |
| :------------: | :------: | :--------------: | :------: | -------------- |
| request_id_1 | response_id_1 | 10 | |  |
| request_id_3 | response_id_3 | 4 | |  |
| request_id_4 | response_id_4 | 40 | |  |

以response_id为基准，比对后的数据：

|      request_id      | response_id |       total_fee       | diff_type | 其余字段…… | 其余字段…… |
| :------------: | :------: | :--------------: | :------: | -------------- | -------------- |
| request_id_1 | response_id_1 | 10 | F000 |  |  |
| request_id_3 | response_id_3 | 4 | F115 |  |  |
| request_id_4 | response_id_4 | 40 | F113 |  |  |
| request_id_2 | response_id_2 | 20 | F114 | |  |

## 稽核示例

> 稽核文件和对账文件为同一个文件，因侧重点不同，以下给出字段侧重展示需要稽核的字段

商户系统支付文件：

| saler_id | total_fee | 其余字段…… | 其余字段…… |
| :------: | :-------: | ---------- | ---------- |
|  saler1  |    10     |            |            |
|  saler2  |    100    |            |            |
|  saler1  |    40     |            |            |
|  saler1  |    20     |            |            |

商户系统提款文件：

| saler_id | withdraw_money | 其余字段…… | 其余字段…… |
| :------: | :------------: | ---------- | ---------- |
|  saler1  |       10       |            |            |
|  saler2  |       10       |            |            |
|  saler2  |       5        |            |            |
|  saler2  |       5        |            |            |

支付系统账号、金额数据：

| saler_id | balance |
| :------: | :-----: |
|  saler1  |   60    |
|  saler2  |   100   |

稽核结果：

| saler_id | balance | 稽核结果 | 稽核金额 |
| :------: | :------------: | ---------- | ---------- |
|  saler1  |       60       |   SUCCESS         |   60         |
|  saler2  |       100       |     FAIL       |      80      |
